#

## 1 - Shared Memory

### Exemple

```
#include <stdlib.h> 
#include<stdio.h>
#include <string.h>
#include <sys/types.h>
#include <sys/shm.h>
#include <sys/wait.h>
#define KEY 4567
#define PERMS 0660

int main(int argc, char **argv) {
    int id; int i; int *ptr;
    system("ipcs -m");
    id = shmget(KEY, sizeof(int), IPC_CREAT | PERMS);
    system("ipcs -m");
    ptr = (int *) shmat(id, NULL, 0);
    *ptr = 54; i = 54;
    if (fork() == 0)
    {   
        (*ptr)++; i++;
        printf("Value of *ptr = %d\nValue of i = %d\n",*ptr, i);
        exit(0);
    } else {
        wait(NULL);
        printf("Value of *ptr = %d\nValue of i = %d\n", *ptr, i);
        shmctl(id, IPC_RMID, NULL);
}
```

Output of this code after execution :

```
Value of *ptr = 55
Value of i = 55
Value of *ptr = 55
Value of i = 54

```

We so we can see that the value of *ptr is modified in the child process, but the incrementation is also visible when we print the value in the parent process.

This isn't normal behaviour, for exemple the variable i is also incremented inside the child process but it is not true inside the parent. Therefore, *ptr has been shared between the the two process.


### Function shmget()

```
int shmget(key_t key, size_t size, int shmflg);
```

This function allow you to allocate memory segment. The shmget will return you this ID of the segment associated to the KEY value.

This fonction take 3 arguments :
1. The KEY value
2. The size of the memory segment
3. Flags (see man shmget to see the diferents flags and what they do)
4. In addition to the flags, you can specify the permissions granted to the owner, group and others.

exemple:

```
id = shmget(KEY, SIZE, IPC_CREAT | 0660);
```

This shmget call will return the identifier (id) of the memory segment associated with the KEY. If this segment is a new one, it will have the size specified in the int SIZE.


### Function shmat()

```
void *shmat(int shmid, const void *shmaddr, int shmflg);
```

This fonction attaches the shared memory segement identified by "shmid" to the adress space of the calling process.

The attaching adress can be specified vy "shmaddr", but we set it to NULL the system choose a unused adress to attach the segment. That's what we will do in the following exercices.

We can also uses flags but we will not use them for the rest of the TP.

## 2. Parallel Computing

To learn how to use those functions, we've made a program to calculate the product of 3 additions, and each addition will be done inside a different process. So we will need shared memory to share the result of each calcul.

Here is the code : 

```
int main(int argc, char const *argv[])
{
	//variables for calcul
	int a,b,c,d,e,f;
	a = 10;
	b = -2; //8
	c = -5; // 2
	d = 7;
	e = 12; //13
	f = 1;

	int tmp = 0;

	//Variables for sharedMemory
	int id; 
	int *ptr;
	id = shmget(KEY, sizeof(int), IPC_CREAT | PERMS);
	ptr = (int *) shmat(id, NULL, 0);
	
	//process 1
	if(fork()==0){
		*ptr = a + b; 
		printf("I'm the process P1 (PID : %d), and my calcul is : %d + %d = %d\n", getpid(), a, b, *ptr);

	}else{
		wait(NULL);
		//Process P2
		if(fork()==0){
			tmp = *ptr * (c + d);
			printf("I'm the process P2 (PID : %d), and my calcul is : %d * (%d + %d) = %d\n", getpid(),*ptr, c, d, tmp); 
			*ptr = tmp;
			exit(0);
		}else{
			wait(NULL);
			//Process P3
			if(fork()==0){
				tmp = *ptr * (e + f);
				printf("I'm the process P3 (PID : %d), and my calcul is : %d * (%d + %d) = %d\n", getpid(),*ptr, e, f, tmp); 
				*ptr = tmp;
				exit(0);
			}	
		}
	}
	wait(NULL);
	return 0;
}
```

We've used 2 fork() in order to make 3 processes. similarly to the exemple in question 1, we've used shmget to get the id of the shared memory segment and shmat to have a pointer to this memory.

Therefore, we can share the result of each addition in the new processes.

### 3.
