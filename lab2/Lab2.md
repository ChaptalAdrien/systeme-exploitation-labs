## 1 - Shared Memory

# Exemple

```
#include <stdlib.h> 
#include<stdio.h>
#include <string.h>
#include <sys/types.h>
#include <sys/shm.h>
#include <sys/wait.h>
#define KEY 4567
#define PERMS 0660

int main(int argc, char **argv) {
    int id; int i; int *ptr;
    system("ipcs -m");
    id = shmget(KEY, sizeof(int), IPC_CREAT | PERMS);
    system("ipcs -m");
    ptr = (int *) shmat(id, NULL, 0);
    *ptr = 54; i = 54;
    if (fork() == 0)
    {   
        (*ptr)++; i++;
        printf("Value of *ptr = %d\nValue of i = %d\n",*ptr, i);
        exit(0);
    } else {
        wait(NULL);
        printf("Value of *ptr = %d\nValue of i = %d\n", *ptr, i);
        shmctl(id, IPC_RMID, NULL);
}
```

# Function shmget()

```
int shmget(key_t key, size_t size, int shmflg);
```

This function allow you to allocate memory segment. The shmget will return you this ID of the segment associated to the KEY value.

This fonction take 3 arguments :
1. The KEY value
2. The size of the memory segment
3. Flags (see man shmget to see the diferents flags and what they do)
4. In addition to the flags, you can specify the permissions granted to the owner, group and others.

exemple:

```
id = shmget(KEY, SIZE, IPC_CREAT | 0660);
```

This shmget call will return the identifier (id) of the memory segment associated with the KEY. If this segment is a new one, it will have the size specified in the int SIZE.


# Function shmat()

```
void *shmat(int shmid, const void *shmaddr, int shmflg);
```

This fonction attaches the shared memory segement identified by "shmid" to the adress space of the calling process.

The attaching adress can be specified vy "shmaddr", but we set it to NULL the system choose a unused adress to attach the segment. That's what we will do in the following exercices.

We can also uses flags but we will not use them for the rest of the TP.

